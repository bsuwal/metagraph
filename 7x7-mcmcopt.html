  <!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Metagraph 7x7 -- MCMC for Optimization</title>
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
    name="description"
    content="A nonpartisan research organization studying applications of geometry and computing to U.S. redistricting."
    />
    <link
    href="https://fonts.googleapis.com/css?family=Playfair+Display:700|Lora:400,400i,700|Source+Sans+Pro:300,400"
    rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.css"
    integrity="sha384-D+9gmBxUQogRLqvARvNLmA9hS2x//eK1FhVb9PiU86gmcrBrJAQT8okdJ4LMp2uv"
    crossorigin="anonymous"
    />
    <script
    defer
    src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.js"
    integrity="sha384-483A6DwYfKeDa0Q52fJmxFXkcPCFfnXMoXblOkJ4JcA8zATN6Tm78UNL72AKk+0O"
    crossorigin="anonymous"
    ></script>
    <script
    defer
    src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/contrib/auto-render.min.js"
    integrity="sha384-yACMu8JWxKzSp/C1YV86pzGiQ/l1YUfE8oPuahJQxzehAjEt2GiQuy/BIvl9KyeF"
    crossorigin="anonymous"
    onload="renderMathInElement(document.body, {delimiters: [
      {left: '$', right: '$', display: false}
      ]});"></script>
    </head>

    <body>


      <header>
        <h1>MCMC for Optimization on a 7x7 Grid</h1>

        <img width="450" src="imgs/gerryconstruct.png?raw=true" alt="A 7-by-7 grid">

        <summary>
          THIS PAGE IS UNDER CONSTRUCTION
        </summary>
      </header>

      <main>

        <h3>So you want to do a gerrymander?</h3>
        <p>
          Up until now, we've developed mathematical tools to try to <em>detect</em> and <em>analyze</em> potential gerrymandering,
          but part of the due-diligence of developing algorithmic tools for a particular purpose is to consider how they might be 
          used for other purposes.  Let's take an opposite point of view and look at how to apply this knowlege to <em>creating</em> a
          gerrymander. 
          When we develop algorithmic tools which interface with society, it's important to consider the 
          full scope of how those tools will be used, and by examining the mathematics from this perspective,
          we can gain greater insight into how we might be able to detect and analyze gerrymandering.   We'll continue 
          working on the 7x7 grid.
        </p>


        <h3>Finding extremes</h3>
        <p>
          The first thing we'll do is use the MCMC <a href="https://mggg.org/metagraph/7x7.html"> sampler we built in the last demo </a>, 
          but instead of using it
          to generate an ensemble of plans to compare against, we'll use it to hunt for plans which award a high
          number of seats to one of the parties.  We've slightly modified the code to look for extreme outcomes. 
          Once you pick your distribution and click to search, the algorithm will run
          for 1,500 steps in short bursts of 150. Every 150 steps, it restarts its walk from the most extreme plan
          it has found so far, and at the end it displays the best one found overall.
        </p>

        <div id="optspace" class="chart center"></div>

        <p>
          The idea behind this is that plans which disproportionately favor one particular party tend to be near each other
          in the metagraph, so we should search for improvements near the best plan we've already seen. However, we don't
          want to get stuck in a neighborhood which has pretty good plans, but not the best, so we introduce some
          randomness
          to get us unstuck, in a way that is moderated by the restart frequency.  
        </p>

        <p>
          You'll notice that this does really well, but not always perfectly. For example, if you make the top three rows
          all <span class="clubs">Clubs</span> and the bottom four all <span class="hearts">Hearts</span>,
          if you try a few times, the algorithm will probably find a plan that lets the <span class="hearts">Hearts</span>
          Party win six seats, but almost certainly not one with seven <span class="hearts">Hearts</span>
          districts. This is for two reasons -- first, that there is only one plan which has seven <span class="hearts">Hearts</span>-favoring
          districts (seven vertical strips), and the second is that this plan has very low degree in the metagraph, so it's
          hard for the random walk to find it. It's remarkable that it can even find a plan with six <span class="hearts">Hearts</span>-favoring
          districts. If you plug that distribution into the sampling tool on the <a href="https://mggg.org/metagraph/7x7.html"> previous page </a> 
          and look at the histograms, you'll see that
          the vast majority of plans have four <span class="hearts">Hearts</span> seats, with a small handful
          of plans with five. Very rarely will it even find a six-<span class="hearts">Hearts</span>-seat plan,
          which demonstrates the effectiveness of the restarting mechanism.
        </p>

        <p>
          This is using the same MCMC algorithm as before, it just remembers the most extreme plan it's seen so far.  
          If we step back for a second, this is a pretty ineffective way of constructing a gerrymander.  If someone 
          decides to pick an unfair map by clicking the MCMC button which generates the most extreme map possible, then 
          it will be extremely easy for us to use the same MCMC algorithm to show that the plan is an extreme outlier.  
          
        </p>



        <h3>Elections aren't a sure thing</h3>
        <p>
          Of course in real life, gerrymanders are harder to detect than this because of the uncertainty in elections.  
          If there is some randomness in the outcomes and the <span class="hearts">Hearts</span> Party wins six of the 
          seven seats, is that because the <span class="clubs">Clubs</span> Party is structurally disadvantaged by the 
          districting plan or were they just unlucky this time? We'll incorporate this into our model and show how we 
          can still use the MCMC sampler to help us answer this question.
        </p>


        <h3>Electoral uncertainty</h3> 
        <p>
         Before we move forward, we need an additional piece of machinery from probability theory.  Up until now, we've
         treated elections as <em>deterministic</em>, meaning that a party will surely win a seat if at least half of the
         squares in the corresponding district are of that color.  Now, we'll introduce a little bit of uncertainty.  To 
         keep the math simple, we'll now say that the <em>probability</em> that a party wins a seat depends on the 
         <em>number of squares in the coresponding district of that color</em>.  We'll use the following rule to decide 
         the probability that the <span class="hearts">Hearts</span> Party wins a seat:
       </p>
        <table>
        <tbody>
        <tr text-align="center">
        <td align="center">Number of <span class="hearts">Hearts</span> Squares</td>
        <td align="center">Chance the <span class="hearts">Hearts</span> Party Wins</td>
        </tr>
        <tr>
        <td align="center">0 <span class="hearts">Hearts</span></td>
        <td align="center">Never</td>
        </tr>
        <tr>
        <td align="center">1 <span class="hearts">Hearts</span></td>
        <td align="center">Never</td>
        </tr>
        <tr>
        <td align="center">2 <span class="hearts">Hearts</span></td>
        <td align="center">10%</td>
        </tr>
        <tr>
        <td align="center">3 <span class="hearts">Hearts</span></td>
        <td align="center">33%</td>
        </tr>
        <tr>
        <td align="center">4 <span class="hearts">Hearts</span></td>
        <td align="center">66%</td>
        </tr>
        <tr>
        <td align="center">5 <span class="hearts">Hearts</span></td>
        <td align="center">90%</td>
        </tr>
        <tr>
        <td align="center">6 <span class="hearts">Hearts</span></td>
        <td align="center">Always</td>
        </tr>
        <tr>
        <td align="center">7 <span class="hearts">Hearts</span></td>
        <td align="center">Always</td>
        </tr>
        </tbody>
        </table>
      <p>
        The rule is the same for the <span class="clubs">Clubs</span> Party.
       </p>

       <p>
         Now, instead of talking about how many seats a particular party wins, 
         we need to talk about how many <em>and</em> with what probability.  Below, you can adjust the arrangement
         of the voters to play around with this concept.  The districting plan is fixed, and as you change the 
         voters, you'll see the probability that the <span class="hearts">Hearts</span> Party wins each district 
         as well as <em>total probabilities</em> for the <span class="hearts">Hearts</span> Party winning 
         any particular number of seats.  Since we only have two parties, this also tells us the same information 
         for the <span class="clubs">Clubs</span> Party's prospects, since, for example, the probability that the 
         <span class="hearts">Hearts</span> Party wins three seats is exactly the same as the probability that the 
         <span class="clubs">Clubs</span> Party wins four seats.
       </p>

       <center><summary>
        DEMO IS UNDER CONSTRUCTION
      </summary></center>
      <div id="gridspace" class="chart rows">
        <div style="display: flex; flex-direction: row; flex-wrap: row; align-items: flex-start; margin-bottom: 2rem;">
          <div class="grid-container" style="margin: 0 2rem">
            <h4>Design a distribution $\Delta$</h4>
            <div id="current-delta" class="grid"></div>
            <button id="random-delta">Randomize $\Delta$</button>
            <p>Click cells to toggle</p>
          </div>
          <div class="grid-container" style="margin: 0 2rem">
            <h4>Districting Plan $\mathcal D$</h4>
            <div id="current-d" class="grid"></div>
          </div>
        </div>
        <h4>How likely is it for the <span class="hearts">Hearts</span> Party to win $k$ seats?</h4>
        <div id="histogram"></div>
        <p>Probability of <em>exactly</em> $k$ <span class="hearts">&hearts;</span> seats</p>
      </div>

      <p>
       From the perspective of whoever is drawing the districts, these probabilities are incredibly
       important.  Notice that if you make each district have four <span class="hearts">Hearts</span> voters and 
       three <span class="clubs">Clubs</span> voters, then there is still a small probability of 
       the <span class="clubs">Clubs</span> Party winning a majority of seats,
       but if you have four districts with seven  <span class="hearts">Hearts</span> voters,  and 
       three with seven <span class="clubs">Clubs</span> voters, then the
       <span class="clubs">Clubs</span> Party can never win a majority of the seats.  A
     </p>
     <p>
       Now, thinking like a gerrymanderer, the key problem to consider is <em>supposing we want at 
      least a certain number of the districts to be 
      won by the <span class="hearts">Hearts</span> Party with a certain probability, how should we
      draw the districts?</em> We've introduced a new degree of freedom, called <em>seat fragility</em> which 
      quantifies how secure the <span class="hearts">Hearts</span> Party feels about the outcome.  Using the example above, 
      we might feel better about drawing a plan where the <span class="hearts">Hearts</span> Party is guaranteed to win
      four of the seven seats than one which leaves the door open for our rivals to win a majority, even if it does allow 
      the possibility of winning a larger majority sometimes.
    </p>
    <p>
      The quantity we're interested in examining is the <em>cumulative probability</em> of the 
      <span class="hearts">Hearts</span> Party winning <em>at least</em> some number of seats $k$. 
      In other words, we can take any districting plan and arrangement of voters and figure out 
      the probability of there being at least $k$ <span class="hearts">Hearts</span> Party wins in 
      our new randomized model.  As we just saw, the plan which maximizes this quantity is different for 
      different choices of $k$.  The safe plan, where four districts have all <span class="hearts">Hearts</span> 
      voters and three have all <span class="clubs">Clubs</span> voters is the best choice if we choose $k$ to be 
      four, but it's definitely not the right one if we want $k$ to be five.  
    </p>
    <p>
      This all seems well and good, but even once we pick $k$, we've made the problem of finding the best plan 
      much harder, at least by hand.  Before, we could kind of rely on a packing-and-cracking heurstic where we 
      try to make the <span class="clubs">Clubs</span> Party win their districts by a bigger margin than the 
      <span class="hearts">Hearts</span> Party wins theirs, but that doesn't seem like quite enough when 
      we're working in this richer probabilistic model.  Fortunately for us, the MCMC algorithm from 
      before is well-equipped to perform this search.
    </p>
    <p>
      Use the demo below to explore this concept. As before, you can arrange the voters on the left and use the buttons 
      in the middle to perform the MCMC search, again doing short bursts of 150 steps.  The algorithm is the same as before, where it performs a random walk and 
      occasionally restarts, keeping track of the best one it found so far.  The two charts on the right show the probabilities
      we're interested in.  The first one is the probability of the <span class="hearts">Hearts</span> Party winning exactly 
      that number of seats, called the <em>probability density</em>, and the one on the bottom is the probability of the <span class="hearts">Hearts</span> Party 
      winning <em>at least</em> that number of seats, called the <em>cumulative density</em>.  Whichever number you click, we'll color the corresponding bar 
      in the cumulative density histogram and the bars greater than or equal to that number in the probability density histogram.  The sum of the probabilitties 
      at all the colored bars in the first histogram will be equal to the sum of the colored bar in the second.  You can adjust the arrangement of voters 
      to see how that affects the likelihood of different outcomes.
      bars 
    </p>

    <center><summary>
      DEMO IS UNDER CONSTRUCTION
    </summary></center>
    <div id="gridspace2" class="chart rows">
      <div style="display: flex; flex-direction: row; flex-wrap: row; align-items: flex-start; margin-bottom: 2rem;">
        <div class="grid-container" style="margin: 0 2rem">
          <h4>Design a distribution $\Delta$</h4>
          <div id="current-delta2" class="grid"></div>
          <button id="random-delta2">Randomize $\Delta$</button>
          <p>Click cells to toggle</p>
        </div>
        <div class="grid-container2" style="margin: 0 2rem">
          <h4>Districting Plan $\mathcal D$</h4>
          <div id="current-d2" class="grid"></div>
        </div>
      </div>
      <h4>Search with MCMC to find the plan which maximizes the probability of the <span class="hearts">Hearts</span> Party winning at least a certain number of seats.</h4><br />
      <p>
        <button-sm id="go-button-1" onclick="mcmc_cdf(1)">1</button-sm><button-sm id="go-button-2" onclick="mcmc_cdf(2)">2</button-sm><button-sm id="go-button-3" onclick="mcmc_cdf(3)">3</button-sm><button-sm id="go-button-4" onclick="mcmc_cdf(4)">4</button-sm><button-sm id="go-button-5" onclick="mcmc_cdf(5)">5</button-sm><button-sm id="go-button-6" onclick="mcmc_cdf(6)">6</button-sm><button-sm id="go-button-7" onclick="mcmc_cdf(7)">7</button-sm>
      </p>
      <div id="histogram2-1"></div>
      <p>Probability of <em>exactly</em> $k$ <span class="hearts">&hearts;</span> seats</p>
      <div id="histogram2-2"></div>
      <p>Probability of <em>at least</em> $k$ <span class="hearts">&hearts;</span> seats</p>
    </div>
    <p>
      Again, this does pretty well, though not always perfectly.  One reason for this is that ten rounds of 
      150 steps is not all that many samples, compared to the total universe of plans. Additionally, instead 
      of simply winning a district by having the majority of its voters be <span class="hearts">Hearts</span>, 
      we care about <em>how many</em> <span class="hearts">Hearts</span> voters are in each district.  To put it 
      more concretely, in the old model, there was no difference between having a $\frac{4}{7}$ <span class="hearts">Hearts</span> 
      and a $\frac{6}{7}$ <span class="hearts">Hearts</span> district and two $\frac{5}{7}$ <span class="hearts">Hearts</span> 
      districts, but now we care about this distinction.  We've gone from eight possible outcomes, <span class="hearts">Hearts</span> 
      winning zero to seven districts, to over 3,000, the number of possible probability distributions over these randomized 
      outcomes. 
    </p>
    <p>
      Going back to thinking like statisticians, what can we do if we want to detect this kind of gerrymander? We can definitely 
      do the same thing as before, where we run our own MCMC search to help us flag the plan as suspicious if it produces 
      an outcome that is unusual.  For example, if the enacted plan gives a high probability for  the <span class="hearts">Hearts</span> 
      Party to win five seats, but most other plans have only a 1 or 2 percent chance of this occurring, we should raise our eyebrows.  
      The issue now is that it's not as clear as it was before when a plan's election outcome is an outlier.  Before, for example, 
      if the enacted plan had six <span class="hearts">Hearts</span> seats but almost every other plan we saw with MCMC had 
      four <span class="hearts">Hearts</span> seats, we could confidently say that the enacted plan was an outlier.  Now that the 
      space of outcomes is richer, so is the <em> space of hypotheses about the objective of the gerrymanderer </em>.  This is what 
      makes MCMC sampling such a powerful tool.  For any property of a plan which we might think is concerning, we can compare it to 
      an ensemble of thousands or millions of other plans, and use statistical methods to determine whether the plan really is an outlier 
      with respect to that measure.

    </p>

  <nav>
    <div class="previous">
      <a href="./" class="nav-link">&laquo; Global structure of the 4x4 grid metagraph</a>
      <a href="./5x5.html" class="nav-link">&laquo; Local explorations on the 5x5 grid metagraph</a>
      <a href="./7x7.html" class="nav-link">&laquo; MCMC on the 7x7 grid metagraph</a>
    </div>

    <div class="current">
      <p class="current-page">MCMC for Optimization on the 7x7 grid metagraph</p>
    </div>

    <div class="next">
      <a href="../table.html" class="nav-link">How big are these universes of districting plans? &raquo;</a>
    </div>
  </nav>

  <footer>
    <p>
      This page was created by <a href="http://zachschutzman.com/"><b>Zachary Schutzman</b></a> based on work at the
      <a href="http://gerrydata.org">Voting Rights Data Institute</a>,
      and is being edited and maintained by MGGG. The project includes joint work with
      <a href="http://sethdrew.com/">Seth Drew</a>, Eugene Henninger-Voss, Amara Jaeger, and Heather Newman.
      Special thanks to Mira Bernstein, whose <a href="https://docs.google.com/spreadsheets/d/1U8XXRwwJ3zLLu9Xx-xsrePBFsCXkYYFj_MB4t-ZaZ4k/edit#gid=2131508220">Liliputia
      project</a> served as inspiration.
    </p>
  </footer>

  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script src="src-meta5/histograms-lib.js"></script>
  <script src="src-meta7/data/problookup.js"></script>
  <script src="src-meta7/mcmc-probopt.js"></script>

  <script src="src-meta7/mcmc-cdf.js"></script>
  <script src="src-meta7/mcmc2.js"></script>


</body>

</html> 